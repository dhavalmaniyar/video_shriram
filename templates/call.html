<!DOCTYPE html>
<html lang="en">
{%load static%}

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{%static '/css/bootstrap.css'%}">
  <title>Document</title>
  <script src='https://cdn.scaledrone.com/scaledrone.min.js' type='text/javascript'></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <style>
    body {
      display: flex;
      height: 100vh;
      margin: 0;
      align-items: center;
      justify-content: center;
      padding: 0 50px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    video {
      max-width: calc(80%);
      margin: 0 50px;
      box-sizing: border-box;
      border-radius: 2px;
      padding: 0;
      box-shadow: rgba(156, 172, 172, 0.2) 0px 2px 2px, rgba(156, 172, 172, 0.2) 0px 4px 4px, rgba(156, 172, 172, 0.2) 0px 8px 8px, rgba(156, 172, 172, 0.2) 0px 16px 16px, rgba(156, 172, 172, 0.2) 0px 32px 32px, rgba(156, 172, 172, 0.2) 0px 64px 64px;
    }

    .copy {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      color: rgba(0, 0, 0, 0.5);
    }

    .navbar {
      z-index: 100;
      position: fixed;
      top: 0;

    }
  </style>
  
</head>

<body>
  <!-- As a heading -->
  <nav class="navbar navbar-light bg-light">
    <span class="navbar-brand mb-0 h1"><img src="{%static '/images/logo.png'%}" width="100%" alt=""></span>
  </nav>

  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>

  <!-- RECORD CALL -->
  <button id="start">
    Start Recording
  </button>
  <button id="stop" disabled>
    Stop Recording
  </button>
  <video id="videoPlayer" autoplay></video>

  <script src="{%static '/js/record.js'%}"></script>




  <!-- <script src="{%static '/js/script.js' %}"></script> -->

  <script>
    // Generate random room name if needed
    if (!location.hash) {
      location.hash = Math.floor(Math.random() * 0xFFFFFF).toString(16);
    }
    const roomHash = location.hash.substring(1);
    console.log(">>>>>>><<<<<<<<<", roomHash)

    // TODO: Replace with your own channel ID
    const drone = new ScaleDrone('yiS12Ts5RdNhebyM');
    // Room name needs to be prefixed with 'observable-'
    const roomName = 'observable-' + roomHash;
    const configuration = {
      iceServers: [{
        urls: 'stun:stun.l.google.com:19302'
      }]
    };
    let room;
    let pc;


    function onSuccess() {};

    function onError(error) {
      console.error(error);
    };

    drone.on('open', error => {
      if (error) {
        return console.error(error);
      }
      room = drone.subscribe(roomName);
      room.on('open', error => {
        if (error) {
          onError(error);
        }
      });
      // We're connected to the room and received an array of 'members'
      // connected to the room (including us). Signaling server is ready.
      room.on('members', members => {
        console.log('MEMBERS', members);
        // console.log('>>>>>>>>>>>>>>>>>'+members[0].id);
        if (members.length <= 1) {
          alert("Share code: " + roomHash);
        }
        $.ajax({
          url: "{%url 'link'%}",
          data: {
            'counter': roomHash
          },
          type: 'POST'
        }).done(function (response) {
          console.log(response);
        });

        if (members.length >= 3) {
          return alert('The room is full');
        }
        // If we are the second user to connect to the room we will be creating the offer
        const isOfferer = members.length === 2;
        startWebRTC(isOfferer);
      });
    });

    // Send signaling data via Scaledrone
    function sendMessage(message) {
      drone.publish({
        room: roomName,
        message
      });
    }

    function startWebRTC(isOfferer) {
      pc = new RTCPeerConnection(configuration);

      // 'onicecandidate' notifies us whenever an ICE agent needs to deliver a
      // message to the other peer through the signaling server
      pc.onicecandidate = event => {
        if (event.candidate) {
          sendMessage({
            'candidate': event.candidate
          });
        }
      };

      // If user is offerer let the 'negotiationneeded' event create the offer
      if (isOfferer) {
        pc.onnegotiationneeded = () => {
          pc.createOffer().then(localDescCreated).catch(onError);
        }
      }

      // When a remote stream arrives display it in the #remoteVideo element
      pc.ontrack = event => {
        const stream = event.streams[0];
        if (!remoteVideo.srcObject || remoteVideo.srcObject.id !== stream.id) {
          remoteVideo.srcObject = stream;
        }
      };

      navigator.mediaDevices.getUserMedia({
        audio: true,
        video: true,
      }).then(stream => {
        // Display your local video in #localVideo element
        localVideo.srcObject = stream;
        // Add your stream to be sent to the conneting peer
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
      }, onError);

      // Listen to signaling data from Scaledrone
      room.on('data', (message, client) => {
        // Message was sent by us
        if (client.id === drone.clientId) {
          return;
        }

        if (message.sdp) {
          // This is called after receiving an offer or answer from another peer
          pc.setRemoteDescription(new RTCSessionDescription(message.sdp), () => {
            // When receiving an offer lets answer it
            if (pc.remoteDescription.type === 'offer') {
              pc.createAnswer().then(localDescCreated).catch(onError);
            }
          }, onError);
        } else if (message.candidate) {
          // Add the new ICE candidate to our connections remote description
          pc.addIceCandidate(
            new RTCIceCandidate(message.candidate), onSuccess, onError
          );
        }
      });
    }

    function localDescCreated(desc) {
      pc.setLocalDescription(
        desc,
        () => sendMessage({
          'sdp': pc.localDescription
        }),
        onError
      );
    }
  </script>
</body>

</html>